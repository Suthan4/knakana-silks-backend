// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}


enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  UPI
  WALLET
  NET_BANKING
}

enum ReturnStatus {
  REQUESTED
  APPROVED
  REJECTED
  COMPLETED
}

enum ConsultationPlatform {
  ZOOM
  WHATSAPP
}

enum ConsultationStatus {
  REQUESTED
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

enum NotificationType {
  ORDER_CONFIRMATION
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  SHIPPING_UPDATE
  DELIVERY_CONFIRMATION
  RETURN_UPDATE
  REFUND_UPDATE
  PASSWORD_RESET
  GENERAL
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum SectionType {
  HERO_SLIDER       
  NEW_ARRIVALS      
  FEATURED          
  COLLECTIONS     
  CATEGORIES        
  CUSTOM           
}

model User {
  id             BigInt           @id @default(autoincrement())
  email          String           @unique
  password       String
  firstName      String
  lastName       String
  phone          String?
  role           UserRole         @default(USER)
  isActive       Boolean          @default(true)
  emailVerified  Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  permissions    Permission[]
  addresses      Address[]
  cart           Cart?
  wishlist       Wishlist?
  orders         Order[]
  reviews        Review[]
  consultations  Consultation[]
  notifications  Notification[]
  searches       SearchHistory[]
  viewedProducts ProductView[]
  refreshTokens  RefreshToken[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model Permission {
  id        BigInt    @id @default(autoincrement())
  userId    BigInt
  module    String
  canCreate Boolean   @default(false)
  canRead   Boolean   @default(true)
  canUpdate Boolean   @default(false)
  canDelete Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, module])
  @@index([userId])
  @@map("permissions")
}

model RefreshToken {
  id        BigInt    @id @default(autoincrement())
  userId    BigInt
  token     String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Category {
  id                  BigInt                @id @default(autoincrement())
  name                String
  slug                String                @unique
  description         String?
  parentId            BigInt?
  metaTitle           String?
  metaDesc            String?
  image               String?
  isActive            Boolean               @default(true)
  order               Int                   @default(0)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  parent              Category?            @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children            Category[]           @relation("CategoryHierarchy")
  homeSections        HomeSection[]        @relation("SectionCategories")
  products            Product[]
  consultationConfigs ConsultationConfig[]

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model Product {
  id                  BigInt                @id @default(autoincrement())
  name                String
  slug                String                @unique
  description         String
  categoryId          BigInt
  basePrice           Decimal               @db.Decimal(10, 2)
  sellingPrice        Decimal               @db.Decimal(10, 2)
  sku                 String                @unique
  isActive            Boolean               @default(true)
  hsnCode             String?
  hasVariants         Boolean
   // Artisan details
  artisanName      String?
  artisanAbout     String?    @db.Text
  artisanLocation  String?

  metaTitle           String?
  metaDesc            String?
  schemaMarkup        String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  category            Category             @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  homeSections        HomeSection[]        @relation("SectionProducts")
  specifications      Specification[]
  variants            ProductVariant[]
  images              ProductImage[]
  stock               Stock[]
  cartItems           CartItem[]
  wishlistItems       WishlistItem[]
  orderItems          OrderItem[]
  reviews             Review[]
  viewHistory         ProductView[]
  consultationConfigs ConsultationConfig[]

  @@index([slug])
  @@index([categoryId])
  @@index([sku])
  @@index([hasVariants])
  @@map("products")
}

model Specification {
  id        BigInt    @id @default(autoincrement())
  productId BigInt
  key       String
  value     String
  createdAt DateTime  @default(now())

  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("specifications")
}

model ProductVariant {
  id         BigInt       @id @default(autoincrement())
  productId  BigInt
  size       String?
  color      String?
  fabric     String?
  price      Decimal      @db.Decimal(10, 2)
  sku        String       @unique
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  stock      Stock[]
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model ProductImage {
  id        BigInt    @id @default(autoincrement())
  productId BigInt
  url       String
  altText   String?
  order     Int       @default(0)
  createdAt DateTime  @default(now())

  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

model Warehouse {
  id        BigInt   @id @default(autoincrement())
  name      String
  code      String   @unique
  address   String
  city      String
  state     String
  pincode   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stock Stock[]

  @@map("warehouses")
}

model Stock {
  id                BigInt             @id @default(autoincrement())
  productId         BigInt            
  variantId         BigInt?            
  warehouseId       BigInt            
  quantity          Int                @default(0)
  lowStockThreshold Int                @default(10)
  updatedAt         DateTime           @updatedAt

  product           Product?          @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant           ProductVariant?   @relation(fields: [variantId], references: [id], onDelete: Cascade)
  warehouse         Warehouse?        @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  adjustments       StockAdjustment[]

  // Add composite unique constraint instead
  // This ensures one product/variant can't have duplicate entries in the same warehouse
  // prevents duplicate stock records for the same product/variant in the same warehouse
  @@unique([productId, variantId, warehouseId]) 
  @@index([productId])
  @@index([variantId])
  @@index([warehouseId])
  @@map("stocks")
}

model StockAdjustment {
  id        BigInt    @id @default(autoincrement())
  stockId   BigInt
  quantity  Int
  reason    String
  createdBy String?
  createdAt DateTime  @default(now())

  stock     Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)

  @@index([stockId])
  @@map("stock_adjustments")
}

model Cart {
  id        BigInt      @id @default(autoincrement())
  userId    BigInt      @unique
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]

  @@map("carts")
}

model CartItem {
  id        BigInt           @id @default(autoincrement())
  cartId    BigInt
  productId BigInt
  variantId BigInt?
  quantity  Int              @default(1)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  cart      Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@map("cart_items")
}

model Wishlist {
  id        BigInt          @id @default(autoincrement())
  userId    BigInt          @unique
  isPublic  Boolean         @default(false)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     WishlistItem[]

  @@map("wishlists")
}

model WishlistItem {
  id         BigInt    @id @default(autoincrement())
  wishlistId BigInt
  productId  BigInt
  createdAt  DateTime  @default(now())

  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([wishlistId, productId])
  @@index([wishlistId])
  @@map("wishlist_items")
}

model Address {
  id             BigInt    @id @default(autoincrement())
  userId         BigInt
  fullName       String
  phone          String
  addressLine1   String
  addressLine2   String?
  city           String
  state          String
  pincode        String
  country        String    @default("India")
  isDefault      Boolean   @default(false)
  type           String    @default("SHIPPING")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  shippingOrders Order[]  @relation("ShippingAddress")
  billingOrders  Order[]  @relation("BillingAddress")

  @@index([userId])
  @@map("addresses")
}

model Order {
  id                BigInt       @id @default(autoincrement())
  userId            BigInt
  orderNumber       String       @unique
  status            OrderStatus  @default(PENDING)
  subtotal          Decimal      @db.Decimal(10, 2)
  discount          Decimal      @db.Decimal(10, 2) @default(0)
  shippingCost      Decimal      @db.Decimal(10, 2)
  total             Decimal      @db.Decimal(10, 2)
  shippingAddressId BigInt
  billingAddressId  BigInt
  couponId          BigInt?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  user              User        @relation(fields: [userId], references: [id])
  shippingAddress   Address     @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress    Address     @relation("BillingAddress", fields: [billingAddressId], references: [id])
  coupon            Coupon?     @relation(fields: [couponId], references: [id])
  items             OrderItem[]
  payment           Payment?
  shipment          Shipment?
  returnRequest     Return?

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id        BigInt           @id @default(autoincrement())
  orderId   BigInt
  productId BigInt
  variantId BigInt?
  quantity  Int
  price     Decimal          @db.Decimal(10, 2)
  createdAt DateTime         @default(now())

  order     Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product         @relation(fields: [productId], references: [id])
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

model Payment {
  id                BigInt         @id @default(autoincrement())
  orderId           BigInt         @unique
  razorpayOrderId   String?        @unique
  razorpayPaymentId String?        @unique
  method            PaymentMethod
  status            PaymentStatus  @default(PENDING)
  amount            Decimal        @db.Decimal(10, 2)
  refundAmount      Decimal        @db.Decimal(10, 2) @default(0)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  order             Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([razorpayOrderId])
  @@map("payments")
}

model Shipment {
  id                BigInt     @id @default(autoincrement())
  orderId           BigInt     @unique
  shiprocketOrderId String?    @unique
  trackingNumber    String?
  courierName       String?
  estimatedDelivery DateTime?
  shippedAt         DateTime?
  deliveredAt       DateTime?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  order             Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([trackingNumber])
  @@map("shipments")
}

model Coupon {
  id            BigInt        @id @default(autoincrement())
  code          String        @unique
  description   String?
  discountType  DiscountType
  discountValue Decimal       @db.Decimal(10, 2)
  minOrderValue Decimal       @db.Decimal(10, 2) @default(0)
  maxUsage      Int?
  usageCount    Int           @default(0)
  perUserLimit  Int?
  validFrom     DateTime
  validUntil    DateTime
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  orders        Order[]

  @@index([code])
  @@map("coupons")
}

model Review {
  id                 BigInt         @id @default(autoincrement())
  productId          BigInt
  userId             BigInt
  rating             Int
  comment            String?
  isVerifiedPurchase Boolean        @default(false)
  helpfulCount       Int            @default(0)
  isApproved         Boolean        @default(false)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  product            Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  images             ReviewImage[]

  @@index([productId])
  @@index([userId])
  @@map("reviews")
}

model ReviewImage {
  id        BigInt    @id @default(autoincrement())
  reviewId  BigInt
  url       String
  createdAt DateTime  @default(now())

  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@map("review_images")
}

model Return {
  id              BigInt        @id @default(autoincrement())
  orderId         BigInt        @unique
  reason          String
  status          ReturnStatus  @default(REQUESTED)
  refundAmount    Decimal       @db.Decimal(10, 2)
  refundType      String?
  approvedBy      String?
  rejectionReason String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  order           Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("returns")
}

model ConsultationConfig {
  id         BigInt     @id @default(autoincrement())
  categoryId BigInt?
  productId  BigInt?
  isActive   Boolean    @default(true)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  category   Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  product    Product?  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([productId])
  @@map("consultation_configs")
}

model Consultation {
  id              BigInt                @id @default(autoincrement())
  userId          BigInt
  productId       BigInt?
  categoryId      BigInt?
  platform        ConsultationPlatform
  preferredDate   DateTime
  preferredTime   String
  status          ConsultationStatus    @default(REQUESTED)
  meetingLink     String?
  approvedBy      String?
  rejectionReason String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("consultations")
}

model Notification {
  id        BigInt            @id @default(autoincrement())
  userId    BigInt
  type      NotificationType
  title     String
  message   String
  isRead    Boolean           @default(false)
  metadata  String?
  createdAt DateTime          @default(now())

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

model SearchHistory {
  id        BigInt    @id @default(autoincrement())
  userId    BigInt?
  query     String
  createdAt DateTime  @default(now())

  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("search_history")
}

model ProductView {
  id        BigInt    @id @default(autoincrement())
  userId    BigInt
  productId BigInt
  viewedAt  DateTime  @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@map("product_views")
}

model Banner {
  id        BigInt    @id @default(autoincrement())
  title     String
  image     String
  link      String?
  text      String?
  isActive  Boolean   @default(true)
  order     Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("banners")
}
model HomeSection {
  id          BigInt      @id @default(autoincrement())
  type        SectionType
  title       String                    // "New Sarees", "Our Collections"
  subtitle    String?                   // Optional subtitle
  isActive    Boolean     @default(true)
  order       Int         @default(0)   // Display order
  limit       Int         @default(8)   // How many items to show
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  products    Product[]   @relation("SectionProducts")
  categories  Category[]  @relation("SectionCategories")

  @@index([isActive, order])
  @@map("home_sections")
}
model SeoMeta {
  id           BigInt    @id @default(autoincrement())
  pageType     String
  pageId       String?
  metaTitle    String
  metaDesc     String
  ogTitle      String?
  ogDesc       String?
  ogImage      String?
  twitterCard  String?
  canonical    String?
  schemaMarkup String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([pageType, pageId])
  @@index([pageType])
  @@map("seo_meta")
}